#!/bin/bash
set -euo pipefail

DIR="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"

# shellcheck source=lib/plugin.bash
. "$DIR/../lib/plugin.bash"
# shellcheck source=lib/curl.bash
. "$DIR/../lib/curl.bash"


if [ "${BUILDKITE_PROJECT_PROVIDER}" != 'gitlab' ]; then
  echo '+++ Provider is not gitlab, can not do anything'
  exit 1
fi

GITLAB_TOKEN_ENV_VAR=$(plugin_read_config TOKEN_VAR_NAME "GITLAB_ACCESS_TOKEN")
if [ -z "${!GITLAB_TOKEN_ENV_VAR:-}" ]; then
  echo "+++ ERROR: gitlab access token not configured in variable ${GITLAB_TOKEN_ENV_VAR}"
  exit 1
fi

GITLAB_URI=$(plugin_read_config GITLAB_URL "gitlab.com")
PROJECT="$(echo "${BUILDKITE_REPO##*"${GITLAB_URI}"}" | cut -c 2- )"
PROJECT_SLUG=$(urlencode "${PROJECT%.git}")
STATUS_NAME=$(plugin_read_config CHECK_NAME "${BUILDKITE_STEP_KEY}")

TOKEN="${!GITLAB_TOKEN_ENV_VAR}"

set_status